rule Possible_COM_Hijacking_Using_ScriptletURL_Registry_Key {
  meta:
    author = "Jonathan Heng"
    description = "Detects potential hijacking via Scriptlet registry key"
    date = "2025-06-01"
    severity = "MEDIUM"
    priority = "MEDIUM"
    platform = "Windows"
    mitre_attack_tactic = "Privilege Escalation, Persistence"
    mitre_attack_technique = "Event Triggered Execution"
    version = "1.00"
    
  events:
    ($event.metadata.event_type = "REGISTRY_CREATION" or $event.metadata.event_type = "REGISTRY_DELETION" or $event.metadata.event_type = "REGISTRY_MODIFICATION")
//  $event.metadata.product_event_type = "4657" // Alternative detection method 
    $event.metadata.vendor_name = "Microsoft"
    $event.target.registry.registry_key = /.*ScriptletURL.*/
    $event.principal.user.userid = $targetUser

  outcome:
    $risk_score = max(50)
    $target_users_uniq_list = array_distinct($targetUser)
 
  condition:
    $event
}
