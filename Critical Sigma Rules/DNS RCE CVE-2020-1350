rule DNS_RCE_CVE_2020_1350 {
  meta:
    author = "Florian Roth (Nextron Systems)"
    description = "Detects exploitation of DNS RCE bug reported in CVE-2020-1350 by the detection of suspicious sub process"
    reference = "https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/, https://web.archive.org/web/20230329172447/https://blog.menasec.net/2019/02/threat-hunting-24-microsoft-windows-dns.html"
    sigma_id = "b5281f31-f9cc-4d0d-95d0-45b91c45b487"
    severity = "CRITICAL"
    priority = "CRITICAL"
    platform = "Windows"
    mitre_attack_tactic = "Initial Access, Execution"
    mitre_attack_technique = "Exploit Public-Facing Application, System Services: Service Execution"
    version = "1.00"

  events:
    $event.metadata.event_type = "PROCESS_LAUNCH"
    (
        $event.principal.process.file.full_path = /\\System32\\dns\.exe$/ nocase and
        (
            $event.target.process.file.full_path != /\\System32\\werfault\.exe/ nocase and
            $event.target.process.file.full_path != /\\System32\\conhost\.exe/ nocase and
            $event.target.process.file.full_path != /\\System32\\dnscmd\.exe/ nocase and 
            $event.target.process.file.full_path != /\\System32\\dns\.exe/ nocase
        )
    )
    
  condition:
    $event
}
