rule Sophos_STE_Malware_Outbreak_Multiple_Host {
  meta:
    author = "Jonathan Heng"
    description = "Detect malware infections when product signature or category indicates malware over multiple hosts"
    severity = "MEDIUM"
    priority = "MEDIUM"
    platform = "Sophos"
    mitre_attack_technique = "T1204.002 Malicious File"
    mitre_attack_tactic = "Execution"
    version = "1.00"

  events:
    $e.metadata.vendor_name = "sophos" nocase
    $e.metadata.description = /Malware detected.*/ nocase
    $e.security_result.category_details = $eventCategory
    $eventCategory = "MALWARE"
    $e.principal.hostname = $host

  match:
    $eventCategory over 10m // Group the detection value within 1 mins for testing. Change the threshold later  

  outcome:    
    $count_hosts = count_distinct($host)

  condition:
    $e and #host > 1    // Currently using 1 host for testing. The actual numbers of hosts to be determined by stakeholder
}
